<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>With Recursive | HyoSeung IT blog</title><meta name=keywords content="SQL,Postgresql"><meta name=description content="🔥 이전에 공통 개발 건이 생겨 ZTree 라는 Lib 을 이용해 개발을 한 적이 있다! 하여 해당 tree 구조의 Data를 뽑기 위해 사용된 API를 확인하던 중 위 문법을 처음 발견했다..! Query에 이런 문법이 존재 하는지도 처음 알았는데 그 사용법과 동작 방식 또한 RDB에서 접하지 못한 방식이라.. 매우 신기했다..! 그 내용이 뭔지 같이 알아보자~~😁✌ With Queries 정의 WITH provides a way to write auxiliary statements for use in a larger query."><meta name=author content="HyoSeung Jeon"><link rel=canonical href=https://HyoseungJeon.github.io/posts/sql/withrecursive/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.js onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://HyoseungJeon.github.io/profile.png><link rel=icon type=image/png sizes=16x16 href=https://HyoseungJeon.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://HyoseungJeon.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://HyoseungJeon.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://HyoseungJeon.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><script defer crossorigin=anonymous src=/js/pro.sidebar.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="With Recursive"><meta property="og:description" content="🔥 이전에 공통 개발 건이 생겨 ZTree 라는 Lib 을 이용해 개발을 한 적이 있다! 하여 해당 tree 구조의 Data를 뽑기 위해 사용된 API를 확인하던 중 위 문법을 처음 발견했다..! Query에 이런 문법이 존재 하는지도 처음 알았는데 그 사용법과 동작 방식 또한 RDB에서 접하지 못한 방식이라.. 매우 신기했다..! 그 내용이 뭔지 같이 알아보자~~😁✌ With Queries 정의 WITH provides a way to write auxiliary statements for use in a larger query."><meta property="og:type" content="article"><meta property="og:url" content="https://HyoseungJeon.github.io/posts/sql/withrecursive/"><meta property="og:image" content="https://HyoseungJeon.github.io/profile2.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-11-07T14:56:02+09:00"><meta property="article:modified_time" content="2023-11-07T14:56:02+09:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://HyoseungJeon.github.io/profile2.png"><meta name=twitter:title content="With Recursive"><meta name=twitter:description content="🔥 이전에 공통 개발 건이 생겨 ZTree 라는 Lib 을 이용해 개발을 한 적이 있다! 하여 해당 tree 구조의 Data를 뽑기 위해 사용된 API를 확인하던 중 위 문법을 처음 발견했다..! Query에 이런 문법이 존재 하는지도 처음 알았는데 그 사용법과 동작 방식 또한 RDB에서 접하지 못한 방식이라.. 매우 신기했다..! 그 내용이 뭔지 같이 알아보자~~😁✌ With Queries 정의 WITH provides a way to write auxiliary statements for use in a larger query."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://HyoseungJeon.github.io/posts/"},{"@type":"ListItem","position":2,"name":"SQL","item":"https://HyoseungJeon.github.io/posts/sql/"},{"@type":"ListItem","position":3,"name":"With Recursive","item":"https://HyoseungJeon.github.io/posts/sql/withrecursive/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"With Recursive","name":"With Recursive","description":"🔥 이전에 공통 개발 건이 생겨 ZTree 라는 Lib 을 이용해 개발을 한 적이 있다! 하여 해당 tree 구조의 Data를 뽑기 위해 사용된 API를 확인하던 중 위 문법을 처음 발견했다..! Query에 이런 문법이 존재 하는지도 처음 알았는데 그 사용법과 동작 방식 또한 RDB에서 접하지 못한 방식이라.. 매우 신기했다..! 그 내용이 뭔지 같이 알아보자~~😁✌ With Queries 정의 WITH provides a way to write auxiliary statements for use in a larger query.","keywords":["SQL","Postgresql"],"articleBody":" 🔥 이전에 공통 개발 건이 생겨 ZTree 라는 Lib 을 이용해 개발을 한 적이 있다! 하여 해당 tree 구조의 Data를 뽑기 위해 사용된 API를 확인하던 중 위 문법을 처음 발견했다..! Query에 이런 문법이 존재 하는지도 처음 알았는데 그 사용법과 동작 방식 또한 RDB에서 접하지 못한 방식이라.. 매우 신기했다..! 그 내용이 뭔지 같이 알아보자~~😁✌ With Queries 정의 WITH provides a way to write auxiliary statements for use in a larger query. These statements, which are often referred to as Common Table Expressions or CTEs, can be thought of as defining temporary tables that exist just for one query. Each auxiliary statement in a WITH clause can be a SELECT, INSERT, UPDATE, or DELETE; and the WITH clause itself is attached to a primary statement that can be a SELECT, INSERT, UPDATE, DELETE, or MERGE. 출처 - https://www.postgresql.org/docs/current/queries-with.html\n요약하면 한개의 임시테이블을 사용하여 조회된 데이터들을 MERGE, 새로운 데이터를 생성, 반환하는 postgreSQL의 하나의 Query이다!\nRecursive Queries The optional RECURSIVE modifier changes WITH from a mere syntactic convenience into a feature that accomplishes things not otherwise possible in standard SQL. Using RECURSIVE, a WITH query can refer to its own output.\nWith 함께 사용되는 Recursive query는 With 구문의 출력을 재귀적으로 다시 사용할 수 있도록 해주는 문법이다!\n조금 더 깊이! 구문의 동작 원리는 단순하다. 초기의 기준 테이블로부터 재귀 조건에 맞는 테이블을 조회하고, 그 테이블을 임시 테이블에 add, 후에 조회 했던 이전 테이블을 기준으로 다시 재귀 조회의 반복이다.\n하여 해당 Query는 재귀 조건과 기준 테이블의 여부가 중요하다! 우리는 재귀라는 단어와 함께 항상 딸려오는 문제를 안다. 바로 무한루프이다! 이 문법 또한 재귀방식 이기 때문에 데이터에 Cycle 형태의 Data가 존재한다면 무한Loop를 돌게 된다..😂 하여 이를 방지하기 위한 여러 방법이 있지만 간단하게는 공통 field로 제공되는 is_cycle와 Path Field를 활용하여 방지할 수 있다! 또한 트리 구조를 표현하기 위한 Query인 만큼, level과 Path를 노출할 수도 있다!\n예제 WITH RECURSIVE search_tree(id, link, data) AS ( SELECT t.id, t.link, t.data FROM tree t UNION ALL SELECT t.id, t.link, t.data FROM tree t, search_tree st WHERE t.id = st.link ) SELECT * FROM search_tree; WITH RECURSIVE search_tree(id, link, data, path) AS ( SELECT t.id, t.link, t.data, ARRAY[t.id] FROM tree t UNION ALL SELECT t.id, t.link, t.data, path || t.id FROM tree t, search_tree st WHERE t.id = st.link ) SELECT * FROM search_tree ORDER BY path; WITH RECURSIVE search_tree(id, link, data, depth) AS ( SELECT t.id, t.link, t.data, 0 FROM tree t UNION ALL SELECT t.id, t.link, t.data, depth + 1 FROM tree t, search_tree st WHERE t.id = st.link ) SELECT * FROM search_tree ORDER BY depth; 기본 사용법은 간단하다! 기본 문법 구문 안에 기준 테이블, 혹은 조회 시작점의 select을을 작성 하고 재귀로 호출할 select 문을 작성하면 새로운 임시 테이블이 만들어 진다! 후에 해당 data를 마음대로 활용하면 된다. 추가적으로 Path나 Depth도 활용이 가능하다!\nWITH RECURSIVE search_graph(id, link, data, depth) AS ( SELECT g.id, g.link, g.data, 1 FROM graph g UNION ALL SELECT g.id, g.link, g.data, sg.depth + 1 FROM graph g, search_graph sg WHERE g.id = sg.link )CYCLE id SET is_cycle USING path SELECT * FROM search_graph; 또한 위에 말했던 cycle 문제도 간단하게 CYCLE id SET is_cycle USING path 구문을 추가하여 해결이 가능하다!\n이외의 자세한 예제나 내용은 출처에 작성한 공식 Docs을 참고하자!!\n내 소스 내 Case는 간단하다! Menu의 권한 정보들을 Tree형태의 Data(실제론 Row 형태)로 조회해 화면에 노출하면 끝..이다! 하여 위 Query를 활용하여 작성이 되어있던 Source를 활용했다! 작업 내용은 단순하게 Node 테이블에 권한 테이블을 JOIN하여 권한 여부를 함께 조회했다! (사실 query 파악에 오래 걸렸지 작업한 내용은 적다..😊)\n내 생각 지금 까지 맡았던 업무의 특징인지.. 내가 Query에 관심이 없는지.. 혹은 공부를 제대로 안했던건지..!! 재귀 Query를 처음 보았다.. 😜 확실히 단순한 Query만 보다가 이런 것들을 보니 호오오..!! 하고 놀라긴 했다!! 단순히 Java에서 할 생각을 했는데 애초에 조회 단에서 부터 Depth와 Sorting, 계층 구조로 까지 Data를 뽑으니.. 확실히 좋아 보이긴 했다! 하지만.. 단점은 쿼리의 조회 성능이 매우 떨어졌다 ㅜ… 대략 데이터는 6,000 개 정도 있던 것 같은데 재귀 방식 때문인지 5초 정도의 조회 시간이 걸렸다..! 이에 더해 ZTree Rendering Time 까지 합하니 어마어마했다.. 다행히 해당 페이지가 Back Office 단이라 크게 문제가 되진 않았지만.. 아마도 Front Office 쪽에서는 확실히 성능 개선이 필요해 보였다! PostgreSQL에서는 위와 같은 Query를 제공하는 것을 확인했으니.. 앞으로 재귀 기능을 이용한 기능이 필요할 때에 확실히 고려할 수 있는 내 식견이 넓어졌으니 너무너무 만족스럽다!!\n출처\n7.8. WITH Queries (Common Table Expressions)\nMySQL :: MySQL 8.0 Reference Manual :: 13.2.20 WITH (Common Table Expressions)\n계층형 쿼리에 쓰일 법한 with recursive 절에 대해 알아봅시다.\nWITH Queries (Common Table Expressions)\n","wordCount":"720","inLanguage":"en","datePublished":"2023-11-07T14:56:02+09:00","dateModified":"2023-11-07T14:56:02+09:00","author":{"@type":"Person","name":"HyoSeung Jeon"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://HyoseungJeon.github.io/posts/sql/withrecursive/"},"publisher":{"@type":"Organization","name":"HyoSeung IT blog","logo":{"@type":"ImageObject","url":"https://HyoseungJeon.github.io/profile.png"}}}</script><link rel=stylesheet href=https://HyoseungJeon.github.io/scss/main.css></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://HyoseungJeon.github.io/ accesskey=h title="Home (Alt + H)"><img src=https://HyoseungJeon.github.io/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://HyoseungJeon.github.io/posts/ title=posts class=btn-12><span style=font-family:SUITE-Regular;font-size:19px>posts</span></a></li><li><a href=https://HyoseungJeon.github.io/tags/ title=tags class=btn-12><span style=font-family:SUITE-Regular;font-size:19px>tags</span></a></li><li><a href=https://HyoseungJeon.github.io/archives/ title=archives class=btn-12><span style=font-family:SUITE-Regular;font-size:19px>archives</span></a></li><li><a href=https://HyoseungJeon.github.io/search/ title="search (Alt + /)" class=btn-12 accesskey=/><span style=font-family:SUITE-Regular;font-size:19px>search</span></a></li></ul></nav></header><main class="main page"><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://HyoseungJeon.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://HyoseungJeon.github.io/posts/>Posts</a>&nbsp;»&nbsp;<a href=https://HyoseungJeon.github.io/posts/sql/>SQL</a></div><h1 class=post-title>With Recursive</h1><div class=post-meta><span title='2023-11-07 14:56:02 +0900 +0900'>November 7, 2023</span>&nbsp;·&nbsp;720 words&nbsp;·&nbsp;HyoSeung Jeon</div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner style=padding-top:10px><ul><li><a href=#with-queries aria-label="With Queries">With Queries</a><ul><li><a href=#%ec%a0%95%ec%9d%98 aria-label=정의>정의</a></li><li><a href=#recursive-queries aria-label="Recursive Queries"><strong>Recursive Queries</strong></a></li><li><a href=#%ec%a1%b0%ea%b8%88-%eb%8d%94-%ea%b9%8a%ec%9d%b4 aria-label="조금 더 깊이!">조금 더 깊이!</a></li></ul></li><li><a href=#%ec%98%88%ec%a0%9c aria-label=예제>예제</a><ul><li><a href=#%eb%82%b4-%ec%86%8c%ec%8a%a4 aria-label="내 소스">내 소스</a></li></ul></li><li><a href=#%eb%82%b4-%ec%83%9d%ea%b0%81 aria-label="내 생각">내 생각</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?(document.getElementById("toc-container").classList.add("wide"),document.getElementById("menu-container").style.display=""):(document.getElementById("toc-container").classList.remove("wide"),document.getElementById("menu-container").style.display="none")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/remixicon@2.2.0/fonts/remixicon.css><link rel=stylesheet href=https://unpkg.com/css-pro-layout@1.1.0/dist/css/css-pro-layout.css><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800;900&amp;display=swap"><script src=https://unpkg.com/@popperjs/core@2></script><div id=menu-container class="layout toc-container wide-r"><aside id=sidebar class="sidebar break-point-sm has-bg-image" style=width:100%;position:sticky;top:var(--gap)><div class=sidebar-layout><div class=sidebar-content><nav class="menu open-current-submenu"><ul><li class="menu-item sub-menu" name=API data-level=0><a href=#><span class=menu-icon><i class=ri-book-line></i></span>
<span class=menu-title>API
<span class=menu-title-suffix>(4)</span></span>
<span class=menu-suffix></span></a><div class=sub-menu-list data-popper-placement=left><ul><li class="menu-item page-menu" name=FCM data-level=1><a href=/posts/api/fcm/ class=page><span class=menu-icon><i class=ri-sticky-note-fill></i></span>
<span class=menu-title>FCM</span>
<span class=menu-suffix></span></a></li><li class="menu-item page-menu" name="Nice 본인인증" data-level=1><a href=/posts/api/nice%EB%B3%B8%EC%9D%B8%EC%9D%B8%EC%A6%9D/ class=page><span class=menu-icon><i class=ri-sticky-note-fill></i></span>
<span class=menu-title>Nice 본인인증</span>
<span class=menu-suffix></span></a></li><li class="menu-item page-menu" name="Nice본인인증 이슈대응" data-level=1><a href=/posts/api/nice%EB%B3%B8%EC%9D%B8%EC%9D%B8%EC%A6%9D%EC%9D%B4%EC%8A%88%EB%8C%80%EC%9D%91/ class=page><span class=menu-icon><i class=ri-sticky-note-fill></i></span>
<span class=menu-title>Nice본인인증 이슈대응</span>
<span class=menu-suffix></span></a></li><li class="menu-item page-menu" name=Nice본인인증이슈대응2 data-level=1><a href=/posts/api/nice%EB%B3%B8%EC%9D%B8%EC%9D%B8%EC%A6%9D%EC%9D%B4%EC%8A%88%EB%8C%80%EC%9D%912/ class=page><span class=menu-icon><i class=ri-sticky-note-fill></i></span>
<span class=menu-title>Nice본인인증이슈대응2</span>
<span class=menu-suffix></span></a></li></ul></div></li><li class="menu-item sub-menu" name=Chrome data-level=0><a href=#><span class=menu-icon><i class=ri-book-line></i></span>
<span class=menu-title>Chrome
<span class=menu-title-suffix>(1)</span></span>
<span class=menu-suffix></span></a><div class=sub-menu-list data-popper-placement=left><ul><li class="menu-item page-menu" name=Debug data-level=1><a href=/posts/chrome/debug/ class=page><span class=menu-icon><i class=ri-sticky-note-fill></i></span>
<span class=menu-title>Debug</span>
<span class=menu-suffix></span></a></li></ul></div></li><li class="menu-item sub-menu" name="Design Pattern" data-level=0><a href=#><span class=menu-icon><i class=ri-book-line></i></span>
<span class=menu-title>Design Pattern
<span class=menu-title-suffix>(3)</span></span>
<span class=menu-suffix></span></a><div class=sub-menu-list data-popper-placement=left><ul><li class="menu-item sub-menu" name="Behavioral Patterns" data-level=1><a href=#><span class=menu-icon><i class=ri-book-line></i></span>
<span class=menu-title>Behavioral Patterns
<span class=menu-title-suffix>(1)</span></span>
<span class=menu-suffix></span></a><div class=sub-menu-list data-popper-placement=left><ul><li class="menu-item page-menu" name="Strategy Pattern" data-level=2><a href=/posts/designpattern/behavioralpatterns/strategypattern/ class=page><span class=menu-icon><i class=ri-sticky-note-fill></i></span>
<span class=menu-title>Strategy Pattern</span>
<span class=menu-suffix></span></a></li></ul></div></li><li class="menu-item page-menu" name="Creational Patterns" data-level=1><a href=/posts/designpattern/creationalpatterns/ class=page><span class=menu-icon><i class=ri-sticky-note-fill></i></span>
<span class=menu-title>Creational Patterns</span>
<span class=menu-suffix></span></a></li><li class="menu-item page-menu" name="Structural Patterns" data-level=1><a href=/posts/designpattern/structuralpatterns/ class=page><span class=menu-icon><i class=ri-sticky-note-fill></i></span>
<span class=menu-title>Structural Patterns</span>
<span class=menu-suffix></span></a></li></ul></div></li><li class="menu-item sub-menu" name=ETC data-level=0><a href=#><span class=menu-icon><i class=ri-book-line></i></span>
<span class=menu-title>ETC
<span class=menu-title-suffix>(3)</span></span>
<span class=menu-suffix></span></a><div class=sub-menu-list data-popper-placement=left><ul><li class="menu-item page-menu" name="MSA Id Auditing" data-level=1><a href=/posts/etc/msaidauditing/ class=page><span class=menu-icon><i class=ri-sticky-note-fill></i></span>
<span class=menu-title>MSA Id Auditing</span>
<span class=menu-suffix></span></a></li><li class="menu-item page-menu" name="MSA 환경 TraceId Logging" data-level=1><a href=/posts/etc/msa-%ED%99%98%EA%B2%BD-traceid-logging/ class=page><span class=menu-icon><i class=ri-sticky-note-fill></i></span>
<span class=menu-title>MSA 환경 TraceId Logging</span>
<span class=menu-suffix></span></a></li><li class="menu-item page-menu" name=OAuth data-level=1><a href=/posts/etc/oauth/ class=page><span class=menu-icon><i class=ri-sticky-note-fill></i></span>
<span class=menu-title>OAuth</span>
<span class=menu-suffix></span></a></li></ul></div></li><li class="menu-item sub-menu" name=HTML data-level=0><a href=#><span class=menu-icon><i class=ri-book-line></i></span>
<span class=menu-title>HTML
<span class=menu-title-suffix>(2)</span></span>
<span class=menu-suffix></span></a><div class=sub-menu-list data-popper-placement=left><ul><li class="menu-item page-menu" name="Page Reload Issue" data-level=1><a href=/posts/html/pagereloadissue/ class=page><span class=menu-icon><i class=ri-sticky-note-fill></i></span>
<span class=menu-title>Page Reload Issue</span>
<span class=menu-suffix></span></a></li><li class="menu-item page-menu" name="Page Reload Issue 2" data-level=1><a href=/posts/html/pagereloadissue2/ class=page><span class=menu-icon><i class=ri-sticky-note-fill></i></span>
<span class=menu-title>Page Reload Issue 2</span>
<span class=menu-suffix></span></a></li></ul></div></li><li class="menu-item sub-menu" name=Intellij data-level=0><a href=#><span class=menu-icon><i class=ri-book-line></i></span>
<span class=menu-title>Intellij
<span class=menu-title-suffix>(2)</span></span>
<span class=menu-suffix></span></a><div class=sub-menu-list data-popper-placement=left><ul><li class="menu-item page-menu" name="Properties Auto Upper" data-level=1><a href=/posts/intellij/propertiesautoupper/ class=page><span class=menu-icon><i class=ri-sticky-note-fill></i></span>
<span class=menu-title>Properties Auto Upper</span>
<span class=menu-suffix></span></a></li><li class="menu-item page-menu" name=Thymeleaf data-level=1><a href=/posts/intellij/thymeleaf/ class=page><span class=menu-icon><i class=ri-sticky-note-fill></i></span>
<span class=menu-title>Thymeleaf</span>
<span class=menu-suffix></span></a></li></ul></div></li><li class="menu-item sub-menu" name=Java data-level=0><a href=#><span class=menu-icon><i class=ri-book-line></i></span>
<span class=menu-title>Java
<span class=menu-title-suffix>(8)</span></span>
<span class=menu-suffix></span></a><div class=sub-menu-list data-popper-placement=left><ul><li class="menu-item page-menu" name="Blocking Queue" data-level=1><a href=/posts/java/blockingqueue/ class=page><span class=menu-icon><i class=ri-sticky-note-fill></i></span>
<span class=menu-title>Blocking Queue</span>
<span class=menu-suffix></span></a></li><li class="menu-item page-menu" name=Cursor data-level=1><a href=/posts/java/cursor/ class=page><span class=menu-icon><i class=ri-sticky-note-fill></i></span>
<span class=menu-title>Cursor</span>
<span class=menu-suffix></span></a></li><li class="menu-item page-menu" name=File data-level=1><a href=/posts/java/file/ class=page><span class=menu-icon><i class=ri-sticky-note-fill></i></span>
<span class=menu-title>File</span>
<span class=menu-suffix></span></a></li><li class="menu-item page-menu" name="Function Package" data-level=1><a href=/posts/java/function-package/ class=page><span class=menu-icon><i class=ri-sticky-note-fill></i></span>
<span class=menu-title>Function Package</span>
<span class=menu-suffix></span></a></li><li class="menu-item page-menu" name=Future data-level=1><a href=/posts/java/future/ class=page><span class=menu-icon><i class=ri-sticky-note-fill></i></span>
<span class=menu-title>Future</span>
<span class=menu-suffix></span></a></li><li class="menu-item page-menu" name=Generic data-level=1><a href=/posts/java/generic/ class=page><span class=menu-icon><i class=ri-sticky-note-fill></i></span>
<span class=menu-title>Generic</span>
<span class=menu-suffix></span></a></li><li class="menu-item page-menu" name=Reflection data-level=1><a href=/posts/java/reflection/ class=page><span class=menu-icon><i class=ri-sticky-note-fill></i></span>
<span class=menu-title>Reflection</span>
<span class=menu-suffix></span></a></li><li class="menu-item page-menu" name=Synchronized data-level=1><a href=/posts/java/synchronized/ class=page><span class=menu-icon><i class=ri-sticky-note-fill></i></span>
<span class=menu-title>Synchronized</span>
<span class=menu-suffix></span></a></li></ul></div></li><li class="menu-item sub-menu" name="Java Script" data-level=0><a href=#><span class=menu-icon><i class=ri-book-line></i></span>
<span class=menu-title>Java Script
<span class=menu-title-suffix>(2)</span></span>
<span class=menu-suffix></span></a><div class=sub-menu-list data-popper-placement=left><ul><li class="menu-item page-menu" name="Custom Validate" data-level=1><a href=/posts/javascript/customvalidate/ class=page><span class=menu-icon><i class=ri-sticky-note-fill></i></span>
<span class=menu-title>Custom Validate</span>
<span class=menu-suffix></span></a></li><li class="menu-item sub-menu" name=Date data-level=1><a href=#><span class=menu-icon><i class=ri-book-line></i></span>
<span class=menu-title>Date
<span class=menu-title-suffix>(1)</span></span>
<span class=menu-suffix></span></a><div class=sub-menu-list data-popper-placement=left><ul><li class="menu-item page-menu" name=setDate data-level=2><a href=/posts/javascript/date/setdate/ class=page><span class=menu-icon><i class=ri-sticky-note-fill></i></span>
<span class=menu-title>setDate</span>
<span class=menu-suffix></span></a></li></ul></div></li></ul></div></li><li class="menu-item sub-menu" name=JQuery data-level=0><a href=#><span class=menu-icon><i class=ri-book-line></i></span>
<span class=menu-title>JQuery
<span class=menu-title-suffix>(2)</span></span>
<span class=menu-suffix></span></a><div class=sub-menu-list data-popper-placement=left><ul><li class="menu-item page-menu" name="JQuery Validate" data-level=1><a href=/posts/jquery/validate/ class=page><span class=menu-icon><i class=ri-sticky-note-fill></i></span>
<span class=menu-title>JQuery Validate</span>
<span class=menu-suffix></span></a></li><li class="menu-item page-menu" name=ZTree data-level=1><a href=/posts/jquery/ztree/ class=page><span class=menu-icon><i class=ri-sticky-note-fill></i></span>
<span class=menu-title>ZTree</span>
<span class=menu-suffix></span></a></li></ul></div></li><li class="menu-item sub-menu" name=Spring data-level=0><a href=#><span class=menu-icon><i class=ri-book-line></i></span>
<span class=menu-title>Spring
<span class=menu-title-suffix>(5)</span></span>
<span class=menu-suffix></span></a><div class=sub-menu-list data-popper-placement=left><ul><li class="menu-item page-menu" name=Async data-level=1><a href=/posts/spring/async/ class=page><span class=menu-icon><i class=ri-sticky-note-fill></i></span>
<span class=menu-title>Async</span>
<span class=menu-suffix></span></a></li><li class="menu-item page-menu" name=Cache data-level=1><a href=/posts/spring/cache/ class=page><span class=menu-icon><i class=ri-sticky-note-fill></i></span>
<span class=menu-title>Cache</span>
<span class=menu-suffix></span></a></li><li class="menu-item page-menu" name=RequestContextHolder data-level=1><a href=/posts/spring/requestcontextholder/ class=page><span class=menu-icon><i class=ri-sticky-note-fill></i></span>
<span class=menu-title>RequestContextHolder</span>
<span class=menu-suffix></span></a></li><li class="menu-item page-menu" name=Scope data-level=1><a href=/posts/spring/scope/ class=page><span class=menu-icon><i class=ri-sticky-note-fill></i></span>
<span class=menu-title>Scope</span>
<span class=menu-suffix></span></a></li><li class="menu-item page-menu" name="Spring Security" data-level=1><a href=/posts/spring/springsecurity/ class=page><span class=menu-icon><i class=ri-sticky-note-fill></i></span>
<span class=menu-title>Spring Security</span>
<span class=menu-suffix></span></a></li></ul></div></li><li class="menu-item sub-menu" name=SQL data-level=0><a href=#><span class=menu-icon><i class=ri-book-line></i></span>
<span class=menu-title>SQL
<span class=menu-title-suffix>(1)</span></span>
<span class=menu-suffix></span></a><div class=sub-menu-list data-popper-placement=left><ul><li class="menu-item page-menu" name="With Recursive" data-level=1><a href=/posts/sql/withrecursive/ class=page><span class=menu-icon><i class=ri-sticky-note-fill></i></span>
<span class=menu-title>With Recursive</span>
<span class=menu-suffix></span></a></li></ul></div></li><li class="menu-item sub-menu" name=Window data-level=0><a href=#><span class=menu-icon><i class=ri-book-line></i></span>
<span class=menu-title>Window
<span class=menu-title-suffix>(1)</span></span>
<span class=menu-suffix></span></a><div class=sub-menu-list data-popper-placement=left><ul><li class="menu-item page-menu" name="Nud 메모리누수" data-level=1><a href=/posts/window/nud%EB%A9%94%EB%AA%A8%EB%A6%AC%EB%88%84%EC%88%98/ class=page><span class=menu-icon><i class=ri-sticky-note-fill></i></span>
<span class=menu-title>Nud 메모리누수</span>
<span class=menu-suffix></span></a></li></ul></div></li><li class="menu-item sub-menu" name=독후감 data-level=0><a href=#><span class=menu-icon><i class=ri-book-line></i></span>
<span class=menu-title>독후감
<span class=menu-title-suffix>(2)</span></span>
<span class=menu-suffix></span></a><div class=sub-menu-list data-popper-placement=left><ul><li class="menu-item page-menu" name="Clean Architecture" data-level=1><a href=/posts/%EB%8F%85%ED%9B%84%EA%B0%90/cleanarchitecture/ class=page><span class=menu-icon><i class=ri-sticky-note-fill></i></span>
<span class=menu-title>Clean Architecture</span>
<span class=menu-suffix></span></a></li><li class="menu-item page-menu" name="쏙쏙 들어오는 함수형 코딩" data-level=1><a href=/posts/%EB%8F%85%ED%9B%84%EA%B0%90/%ED%95%A8%EC%88%98%ED%98%95%EC%BD%94%EB%94%A9/ class=page><span class=menu-icon><i class=ri-sticky-note-fill></i></span>
<span class=menu-title>쏙쏙 들어오는 함수형 코딩</span>
<span class=menu-suffix></span></a></li></ul></div></li><li class="menu-item sub-menu" name=일기장 data-level=0><a href=#><span class=menu-icon><i class=ri-book-line></i></span>
<span class=menu-title>일기장
<span class=menu-title-suffix>(1)</span></span>
<span class=menu-suffix></span></a><div class=sub-menu-list data-popper-placement=left><ul><li class="menu-item page-menu" name=23.07.18 data-level=1><a href=/posts/%EC%9D%BC%EA%B8%B0%EC%9E%A5/23-07-18/ class=page><span class=menu-icon><i class=ri-sticky-note-fill></i></span>
<span class=menu-title>23.07.18</span>
<span class=menu-suffix></span></a></li></ul></div></li><ul></nav></div></div><div class=sidebar-footer></div></aside></div><style scoped></style><link rel=stylesheet href=https://HyoseungJeon.github.io/scss/pro-sidebar.css><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition()},!1),window.addEventListener("resize",function(){checkTocPosition()},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("menu-container").style.display="":document.getElementById("menu-container").style.display="none"}</script><div class=post-content><hr><style>#callout{background:#f1f1ef;padding:1.5em 1.25em;border-radius:3px;display:flex;flex-direction:row;margin-bottom:20px;color:var(--hljs-bg)}#callout-inner{margin-left:1em;white-space:pre-line}@media(max-width:767px){#callout{padding:1.5em .75em 1.5em .6em}#callout-inner{margin-left:.5em}}</style><div id=callout><div>🔥</div><div id=callout-inner>이전에 공통 개발 건이 생겨 ZTree 라는 Lib 을 이용해 개발을 한 적이 있다! 하여 해당 tree 구조의 Data를 뽑기 위해 사용된 API를 확인하던 중 위 문법을 처음 발견했다..!
Query에 이런 문법이 존재 하는지도 처음 알았는데 그 사용법과 동작 방식 또한 RDB에서 접하지 못한 방식이라.. 매우 신기했다..! 그 내용이 뭔지 같이 알아보자~~😁✌</div></div><h2 id=with-queries>With Queries<a hidden class=anchor aria-hidden=true href=#with-queries>#</a></h2><h3 id=정의>정의<a hidden class=anchor aria-hidden=true href=#정의>#</a></h3><blockquote><p><code>WITH</code> provides a way to write auxiliary statements for use in a larger query. These statements, which are often referred to as Common Table Expressions or CTEs, can be thought of as defining temporary tables that exist just for one query. Each auxiliary statement in a <code>WITH</code> clause can be a <code>SELECT</code>, <code>INSERT</code>, <code>UPDATE</code>, or <code>DELETE</code>; and the <code>WITH</code> clause itself is attached to a primary statement that can be a <code>SELECT</code>, <code>INSERT</code>, <code>UPDATE</code>, <code>DELETE</code>, or <code>MERGE</code>.
출처 - <a href=https://www.postgresql.org/docs/current/queries-with.html>https://www.postgresql.org/docs/current/queries-with.html</a></p></blockquote><p>요약하면 한개의 임시테이블을 사용하여 조회된 데이터들을 MERGE, 새로운 데이터를 생성, 반환하는 postgreSQL의 하나의 Query이다!</p><h3 id=recursive-queries><strong>Recursive Queries</strong><a hidden class=anchor aria-hidden=true href=#recursive-queries>#</a></h3><blockquote><p>The optional <code>RECURSIVE</code> modifier changes <code>WITH</code> from a mere syntactic convenience into a feature that accomplishes things not otherwise possible in standard SQL. Using <code>RECURSIVE</code>, a <code>WITH</code> query can refer to its own output.</p></blockquote><p>With 함께 사용되는 Recursive query는 With 구문의 출력을 재귀적으로 다시 사용할 수 있도록 해주는 문법이다!</p><h3 id=조금-더-깊이>조금 더 깊이!<a hidden class=anchor aria-hidden=true href=#조금-더-깊이>#</a></h3><p>구문의 동작 원리는 단순하다. 초기의 기준 테이블로부터 재귀 조건에 맞는 테이블을 조회하고, 그 테이블을 임시 테이블에 add, 후에 조회 했던 이전 테이블을 기준으로 다시 재귀 조회의 반복이다.</p><p>하여 해당 Query는 재귀 조건과 기준 테이블의 여부가 중요하다!
우리는 재귀라는 단어와 함께 항상 딸려오는 문제를 안다. 바로 무한루프이다! 이 문법 또한 재귀방식 이기 때문에 데이터에 Cycle 형태의 Data가 존재한다면 무한Loop를 돌게 된다..😂 하여 이를 방지하기 위한 여러 방법이 있지만 간단하게는 공통 field로 제공되는 is_cycle와 Path Field를 활용하여 방지할 수 있다!
또한 트리 구조를 표현하기 위한 Query인 만큼, level과 Path를 노출할 수도 있다!</p><h2 id=예제>예제<a hidden class=anchor aria-hidden=true href=#예제>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>WITH</span><span class=w> </span><span class=k>RECURSIVE</span><span class=w> </span><span class=n>search_tree</span><span class=p>(</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>link</span><span class=p>,</span><span class=w> </span><span class=k>data</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=n>link</span><span class=p>,</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=k>data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>tree</span><span class=w> </span><span class=n>t</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>UNION</span><span class=w> </span><span class=k>ALL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=n>link</span><span class=p>,</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=k>data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>tree</span><span class=w> </span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=n>search_tree</span><span class=w> </span><span class=n>st</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>WHERE</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>st</span><span class=p>.</span><span class=n>link</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>search_tree</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WITH</span><span class=w> </span><span class=k>RECURSIVE</span><span class=w> </span><span class=n>search_tree</span><span class=p>(</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>link</span><span class=p>,</span><span class=w> </span><span class=k>data</span><span class=p>,</span><span class=w> </span><span class=n>path</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=n>link</span><span class=p>,</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=k>data</span><span class=p>,</span><span class=w> </span><span class=nb>ARRAY</span><span class=p>[</span><span class=n>t</span><span class=p>.</span><span class=n>id</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>tree</span><span class=w> </span><span class=n>t</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>UNION</span><span class=w> </span><span class=k>ALL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=n>link</span><span class=p>,</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=k>data</span><span class=p>,</span><span class=w> </span><span class=n>path</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=n>id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>tree</span><span class=w> </span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=n>search_tree</span><span class=w> </span><span class=n>st</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>WHERE</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>st</span><span class=p>.</span><span class=n>link</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>search_tree</span><span class=w> </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>path</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WITH</span><span class=w> </span><span class=k>RECURSIVE</span><span class=w> </span><span class=n>search_tree</span><span class=p>(</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>link</span><span class=p>,</span><span class=w> </span><span class=k>data</span><span class=p>,</span><span class=w> </span><span class=n>depth</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=n>link</span><span class=p>,</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=k>data</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>tree</span><span class=w> </span><span class=n>t</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>UNION</span><span class=w> </span><span class=k>ALL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=n>link</span><span class=p>,</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=k>data</span><span class=p>,</span><span class=w> </span><span class=n>depth</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>tree</span><span class=w> </span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=n>search_tree</span><span class=w> </span><span class=n>st</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>WHERE</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>st</span><span class=p>.</span><span class=n>link</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>search_tree</span><span class=w> </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>depth</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>기본 사용법은 간단하다! 기본 문법 구문 안에 기준 테이블, 혹은 조회 시작점의 select을을 작성 하고 재귀로 호출할 select 문을 작성하면 새로운 임시 테이블이 만들어 진다! 후에 해당 data를 마음대로 활용하면 된다.
추가적으로 Path나 Depth도 활용이 가능하다!</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>WITH</span><span class=w> </span><span class=k>RECURSIVE</span><span class=w> </span><span class=n>search_graph</span><span class=p>(</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>link</span><span class=p>,</span><span class=w> </span><span class=k>data</span><span class=p>,</span><span class=w> </span><span class=n>depth</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=k>g</span><span class=p>.</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=k>g</span><span class=p>.</span><span class=n>link</span><span class=p>,</span><span class=w> </span><span class=k>g</span><span class=p>.</span><span class=k>data</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>graph</span><span class=w> </span><span class=k>g</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>UNION</span><span class=w> </span><span class=k>ALL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=k>g</span><span class=p>.</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=k>g</span><span class=p>.</span><span class=n>link</span><span class=p>,</span><span class=w> </span><span class=k>g</span><span class=p>.</span><span class=k>data</span><span class=p>,</span><span class=w> </span><span class=n>sg</span><span class=p>.</span><span class=n>depth</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>graph</span><span class=w> </span><span class=k>g</span><span class=p>,</span><span class=w> </span><span class=n>search_graph</span><span class=w> </span><span class=n>sg</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>WHERE</span><span class=w> </span><span class=k>g</span><span class=p>.</span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sg</span><span class=p>.</span><span class=n>link</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=k>CYCLE</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=n>is_cycle</span><span class=w> </span><span class=k>USING</span><span class=w> </span><span class=n>path</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>search_graph</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>또한 위에 말했던 cycle 문제도 간단하게 <code>CYCLE id SET is_cycle USING path</code> 구문을 추가하여 해결이 가능하다!</p><p>이외의 자세한 예제나 내용은 출처에 작성한 공식 Docs을 참고하자!!</p><h3 id=내-소스>내 소스<a hidden class=anchor aria-hidden=true href=#내-소스>#</a></h3><p>내 Case는 간단하다! Menu의 권한 정보들을 Tree형태의 Data(실제론 Row 형태)로 조회해 화면에 노출하면 끝..이다! 하여 위 Query를 활용하여 작성이 되어있던 Source를 활용했다! 작업 내용은 단순하게 Node 테이블에 권한 테이블을 JOIN하여 권한 여부를 함께 조회했다! (사실 query 파악에 오래 걸렸지 작업한 내용은 적다..😊)</p><h2 id=내-생각>내 생각<a hidden class=anchor aria-hidden=true href=#내-생각>#</a></h2><p>지금 까지 맡았던 업무의 특징인지.. 내가 Query에 관심이 없는지.. 혹은 공부를 제대로 안했던건지..!! 재귀 Query를 처음 보았다.. 😜 확실히 단순한 Query만 보다가 이런 것들을 보니 호오오..!! 하고 놀라긴 했다!! 단순히 Java에서 할 생각을 했는데 애초에 조회 단에서 부터 Depth와 Sorting, 계층 구조로 까지 Data를 뽑으니.. 확실히 좋아 보이긴 했다!
하지만.. 단점은 쿼리의 조회 성능이 매우 떨어졌다 ㅜ… 대략 데이터는 6,000 개 정도 있던 것 같은데 재귀 방식 때문인지 5초 정도의 조회 시간이 걸렸다..! 이에 더해 ZTree Rendering Time 까지 합하니 어마어마했다.. 다행히 해당 페이지가 Back Office 단이라 크게 문제가 되진 않았지만.. 아마도 Front Office 쪽에서는 확실히 성능 개선이 필요해 보였다! PostgreSQL에서는 위와 같은 Query를 제공하는 것을 확인했으니.. 앞으로 재귀 기능을 이용한 기능이 필요할 때에 확실히 고려할 수 있는 내 식견이 넓어졌으니 너무너무 만족스럽다!!</p><p>출처</p><p><a href=https://www.postgresql.org/docs/current/queries-with.html>7.8. WITH Queries (Common Table Expressions)</a></p><p><a href=https://dev.mysql.com/doc/refman/8.0/en/with.html#common-table-expressions-recursive>MySQL :: MySQL 8.0 Reference Manual :: 13.2.20 WITH (Common Table Expressions)</a></p><p><a href=https://codingdog.tistory.com/entry/%EA%B3%84%EC%B8%B5%ED%98%95-%EC%BF%BC%EB%A6%AC%EC%97%90-%EC%93%B0%EC%9D%BC-%EB%B2%95%ED%95%9C-with-recursive-%EC%A0%88%EC%97%90-%EB%8C%80%ED%95%B4-%EC%95%8C%EC%95%84%EB%B4%85%EC%8B%9C%EB%8B%A4>계층형 쿼리에 쓰일 법한 with recursive 절에 대해 알아봅시다.</a></p><p><a href=https://www.postgresql.kr/docs/9.2/queries-with.html>WITH Queries (Common Table Expressions)</a></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://HyoseungJeon.github.io/tags/sql/>SQL</a></li><li><a href=https://HyoseungJeon.github.io/tags/postgresql/>Postgresql</a></li></ul><nav class=paginav><a class=prev href=https://HyoseungJeon.github.io/posts/spring/springsecurity/><span class=title>« Prev</span><br><span>Spring Security</span></a>
<a class=next href=https://HyoseungJeon.github.io/posts/jquery/ztree/><span class=title>Next »</span><br><span>ZTree</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://HyoseungJeon.github.io/>HyoSeung IT blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>